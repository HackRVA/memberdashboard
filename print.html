<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js navy">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>member dashboard</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Operations</li><li class="chapter-item expanded "><a href="operations/admin.html"><strong aria-hidden="true">1.</strong> Admin</a></li><li class="chapter-item expanded "><a href="operations/api.html"><strong aria-hidden="true">2.</strong> API</a></li><li class="chapter-item expanded "><a href="operations/database.html"><strong aria-hidden="true">3.</strong> Database</a></li><li class="chapter-item expanded "><a href="operations/disaster-recovery.html"><strong aria-hidden="true">4.</strong> Disaster Recovery</a></li><li class="chapter-item expanded "><a href="operations/edge_cases.html"><strong aria-hidden="true">5.</strong> Edge Cases</a></li><li class="chapter-item expanded "><a href="operations/frontdoor.html"><strong aria-hidden="true">6.</strong> Frontdoor</a></li><li class="chapter-item expanded "><a href="operations/infrastructure.html"><strong aria-hidden="true">7.</strong> Infrastructure</a></li><li class="chapter-item expanded "><a href="operations/integrations.html"><strong aria-hidden="true">8.</strong> Integrations</a></li><li class="chapter-item expanded "><a href="operations/payment-provider.html"><strong aria-hidden="true">9.</strong> Payment Provider</a></li><li class="chapter-item expanded affix "><li class="part-title">Hardware</li><li class="chapter-item expanded "><a href="hardware/rfid.html"><strong aria-hidden="true">10.</strong> RFID</a></li><li class="chapter-item expanded "><a href="hardware/esprfid.html"><strong aria-hidden="true">11.</strong> esprfid</a></li><li class="chapter-item expanded "><a href="hardware/mqtt.html"><strong aria-hidden="true">12.</strong> mqtt</a></li><li class="chapter-item expanded affix "><li class="part-title">Development</li><li class="chapter-item expanded "><a href="development/getting_started.html"><strong aria-hidden="true">13.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="development/setup.html"><strong aria-hidden="true">14.</strong> Setup</a></li><li class="chapter-item expanded "><a href="development/installing_flutter.html"><strong aria-hidden="true">15.</strong> Installing flutter</a></li><li class="chapter-item expanded "><a href="development/config.html"><strong aria-hidden="true">16.</strong> Config</a></li><li class="chapter-item expanded "><a href="development/development-tasks.html"><strong aria-hidden="true">17.</strong> Development Tasks</a></li><li class="chapter-item expanded "><a href="development/migratedb.html"><strong aria-hidden="true">18.</strong> Database Migrations</a></li><li class="chapter-item expanded "><a href="development/seeddb.html"><strong aria-hidden="true">19.</strong> Seed DB</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">member dashboard</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/HackRVA/memberdashboard" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="admin-access"><a class="header" href="#admin-access">Admin Access</a></h1>
<p>Admin access is the ability to assign rfid fobs to members and change what they have access to.</p>
<h2 id="granting-access"><a class="header" href="#granting-access">Granting access</a></h2>
<p>To give someone access, you assign them to the <code>admin</code> resource.</p>
<p>The <code>admin</code> resource is a special resource that doesn't broadcast MQTT messages.</p>
<p>If a member has the <code>admin</code> resource, they will see <code>reports</code>, <code>members</code>, and <code>resources</code> tabs in the UI.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="api"><a class="header" href="#api">API</a></h1>
<h2 id="swaggerui"><a class="header" href="#swaggerui">SwaggerUI</a></h2>
<p>SwaggerUI is the static site for serving up our api documentation.</p>
<p>The static html/js files can be found in the SwaggerUI release (in the dist folder)
https://github.com/swagger-api/swagger-ui</p>
<h2 id="generate-the-documentation"><a class="header" href="#generate-the-documentation">Generate the documentation</a></h2>
<p>This project is documented with <a href="https://github.com/go-swagger/go-swagger">go-swagger</a> </p>
<p>Download the binary from <a href="https://github.com/go-swagger/go-swagger/releases">here</a></p>
<p>You will probably have to allow the binary to be executable</p>
<pre><code>chmod +x swagger_linux_amd64
</code></pre>
<p>Then copy/move the binary somewhere you can access it</p>
<pre><code>cp swagger_linux_amd64 /usr/local/bin/swagger
</code></pre>
<p>Once you have your swagger binary, you can run the <code>gendocs.sh</code> script in the root of the repo.
This will create the <code>swagger.json</code> file and place it in the <code>./docs/swaggerui/</code> directory.</p>
<p>You will then be able to access the swagger documentation at <code>/swaggerui/</code> in your web browser.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="database"><a class="header" href="#database">Database</a></h1>
<p>The database runs Postgres.</p>
<p>I recommend using pgadmin to interact with the database.  Ideally direct manipulation of the DB should be avoided (there are some edge cases where this is necessary).
The database schema is managed with migrations.  see the main readme of this repo for more info.</p>
<h2 id="tables"><a class="header" href="#tables">Tables</a></h2>
<div class="table-wrapper"><table><thead><tr><th>table name</th><th>description</th></tr></thead><tbody>
<tr><td>access_events</td><td>We store access events here.  This currently isn't used by anything other than reports (e.g. how many swipes per day).</td></tr>
<tr><td>*communication</td><td>The communication table is basically an enum of types of messages that we can send out</td></tr>
<tr><td>*communication_log</td><td>a log of messages that we have sent out</td></tr>
<tr><td>member_counts</td><td>Everyday, we update how many members we have for each membership level. This allows us to track how our membership has changed each month</td></tr>
<tr><td>member_credit</td><td>deprecated - can be removed</td></tr>
<tr><td>member_resource</td><td>stores the relationship between members and what resources they have access to</td></tr>
<tr><td>member_tiers</td><td>an enum of member levels</td></tr>
<tr><td>members</td><td>membership information</td></tr>
<tr><td>payments</td><td>deprecated - can be removed - will be removed on next migrate up</td></tr>
<tr><td>resources</td><td>resource information - name, address, how to communicate with the resource</td></tr>
<tr><td>users</td><td>users are tied to members.  The distinction is that users use the dashboard.  We don't support non-members making user accounts</td></tr>
</tbody></table>
</div>
<blockquote>
<p>*Emails are currently disabled</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="disaster-recovery"><a class="header" href="#disaster-recovery">Disaster Recovery</a></h1>
<h2 id="if-this-system-goes-down-how-do-we-recover"><a class="header" href="#if-this-system-goes-down-how-do-we-recover">If this system goes down, How do we recover?</a></h2>
<p>We take periodic snapshots and backups of the entire DB.  It's probably preferable to restore the entire DB.<br />
However, if that's not an option, read on.</p>
<p>Most of the things in the database can be calculated or retrieved.</p>
<p>The bare minimum you need to restore the system is returned from the following query.</p>
<pre><code class="language-SQL">SELECT name, email, rfid, subscription_id
	FROM membership.members;
</code></pre>
<h3 id="member-status"><a class="header" href="#member-status">Member Status</a></h3>
<p>Member Status is evaluated daily.  The <code>subscription_id</code> is used to lookup the member's subscription in the payment provider.</p>
<p>Occasionally, we have members that have <code>Credited</code> memberships.  This can happen if someone wants to pay for only a month of membership or if someone gifts a few months of membership to someone.
With the bare minimum restore, <code>Credited</code> members would not persisted their <code>Credited</code> status.  This should be tracked out of band from this application (i.e. the treasurer keeps track of who has this and when they need to be removed from <code>Credited</code> status).</p>
<h3 id="rfid-fobs"><a class="header" href="#rfid-fobs">RFID fobs</a></h3>
<p>In a pinch, you could get a list of membership details (name, email, subscription_id) from the treasurer and then get a list of the active RFIDs off of the the rfid device (it store them on local flash).</p>
<h3 id="worst-case-scenario"><a class="header" href="#worst-case-scenario">Worst case scenario</a></h3>
<p>If you've lost everything, you'll just have to get people to register their fobs again.</p>
<p>The dashboard does have an option for self service.  A member can create an account and assign themselves a new fob.  Normal members don't have access to change other members fobs and they don't have access to assign new access to themselves.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="edge-cases"><a class="header" href="#edge-cases">Edge Cases</a></h1>
<blockquote>
<p>note: Be extra careful when making direct changes to the DB.  This is typically not recommended.  We humans make errors.</p>
</blockquote>
<h2 id="an-existing-member-starts-a-subscription-for-someone-else"><a class="header" href="#an-existing-member-starts-a-subscription-for-someone-else">An existing member starts a subscription for someone else.</a></h2>
<p>We received the subscriptionID from paypal, but we already have that paying member's email in the DB.
The DB has a constraint that prevents it from using the same email address for two different members.
So, the system created a new &quot;member&quot; with only the subscriptionID populated.
(i.e. no name, no email)
i.e.</p>
<div class="table-wrapper"><table><thead><tr><th>id</th><th>name</th><th>email</th><th>rfid</th><th>member_tier_id</th><th>subscription_id</th></tr></thead><tbody>
<tr><td>&lt;some_id&gt;</td><td>null</td><td>null</td><td>null</td><td>inactive</td><td>&lt;some_subscription_id&gt;</td></tr>
</tbody></table>
</div>
<p>I created a new member for them in the dashboard.  This allowed me to input their name and email address and assign them a fob that worked immediately.</p>
<div class="table-wrapper"><table><thead><tr><th>id</th><th>name</th><th>email</th><th>rfid</th><th>member_tier_id</th><th>subscription_id</th></tr></thead><tbody>
<tr><td>&lt;some_id&gt;</td><td>&lt;some_name&gt;</td><td>&lt;some_email&gt;</td><td>&lt;some_rfid&gt;</td><td>&lt;some_membership_level&gt;</td><td>null</td></tr>
</tbody></table>
</div>
<p>On the following day, the member would lose access because they don't have a <code>subscription_id</code></p>
<p>This can't be fixed in the UI because the UI doesn't allow you to delete members and you aren't allowed to give two members the same <code>subscription_id</code>.</p>
<p>The only way to fix this is to run a few DB queries.</p>
<ol>
<li>Get the new member's <code>subscription_id</code>.  If you don't know how to get this, you may have to contact the treasurer.</li>
<li>verify that we don't already have a member with that <code>subscription_id</code> (there's a constraint that prevents multiple members having the same <code>subscription_id</code>)</li>
</ol>
<pre><code class="language-SQL">SELECT id, name, email, rfid, member_tier_id, subscription_id
	FROM membership.members
	WHERE subscription_id = '&lt;new subscription id&gt;';
</code></pre>
<p>In this case, I found that the new <code>subscription_id</code> overwrote the original member's existing <code>subscription_id</code>.
So, I will have to go find their existing <code>subscription_id</code> and correct this.</p>
<pre><code class="language-SQL">UPDATE membership.members
	SET subscription_id='&lt;original subscription id&gt;'
	WHERE subscription_id = '&lt;new subscription id&gt;'
</code></pre>
<p>corrected.</p>
<p>Now that we are sure that no other member has that <code>subscription_id</code>, we can update their <code>subscription_id</code> via the UI.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="frontdoor"><a class="header" href="#frontdoor">Frontdoor</a></h1>
<p>Note that this device stores access information locally in flash.
If for some reason, it does not have network connection, the device will still operate.  However, it will not receive updates.</p>
<p>It's important to occasionally check that the device is connected.  One easy way to do this is in the member dashboard ui on the resources tab.</p>
<p>The device tells us that it's online at some interval.  If it loses connection (or if the server just started), the dashboard will know that it's offline.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="infrastructure"><a class="header" href="#infrastructure">Infrastructure</a></h1>
<pre class="mermaid">flowchart LR;
        database[(Database)]&lt;-. sql connection over ssl .-&gt;firewall
        &lt;-.-&gt;proxy([http reverse proxy])&lt;-.-&gt;server(member dashboard/server)
        &lt;-. mqtt messages .-&gt;mqttbroker([mosquitto/mqtt broker])
        mqttbroker&lt;-. mqtt message .-&gt;frontdoor([front door rfid])
        mqttbroker&lt;-. mqtt message .-&gt;cnc([CNC rfid])
        mqttbroker&lt;-. mqtt message .-&gt;laser([laser rfid])
        mqttbroker&lt;-. mqtt message .-&gt;resources([rfid device])
</pre>
<ul>
<li>The db runs on a hosting provider in the cloud. </li>
<li>The server is internal.  The server could also run in the cloud, but that would require us to expose the MQTT broker through the firewall.</li>
<li>The web ui (which runs on the server) is exposed through a proxy.</li>
<li>The server communicates to the rfid endpoints (aka resources) through the MQTT protocol.</li>
</ul>
<h2 id="database-1"><a class="header" href="#database-1">Database</a></h2>
<p>The database runs postgres.</p>
<h2 id="server"><a class="header" href="#server">Server</a></h2>
<p>Responsibilities:</p>
<ul>
<li>handle backend requests for the &quot;Member Dashboard&quot; (aka the web ui)</li>
<li>serve up the web ui</li>
<li>publish/subscribe MQTT messages</li>
<li>run tasks at scheduled intervals (e.g. reach out to payment providers to verify that members are up to date)</li>
</ul>
<h2 id="web-ui"><a class="header" href="#web-ui">Web UI</a></h2>
<p>The web ui is a dashboard that makes managing the space more convenient.  It controls who has access to what and shows some membership stats.</p>
<h2 id="mqtt-broker"><a class="header" href="#mqtt-broker">MQTT Broker</a></h2>
<p>The MQTT Broker allows the server to communicate to resources on the network (e.g. the frontdoor rfid device).</p>
<h2 id="resources"><a class="header" href="#resources">Resources</a></h2>
<p>Resources is a term used for RFID devices.  However, they don't have to be an rfid device.  Essentially, a resource is just something that we can communicate with via MQTT.</p>
<p>For example, you could potentially build out an LED light controller that publishes and subscribes to MQTT events and then build some module on this member dashboard to control it.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="integrations"><a class="header" href="#integrations">Integrations</a></h1>
<p>This app uses a few integrations.
See below to find more information on how to request access through those vendors</p>
<h2 id="slack-webhook-setup"><a class="header" href="#slack-webhook-setup">Slack webhook setup</a></h2>
<blockquote>
<p>https://hackrva.slack.com/apps/A0F7XDUAZ-incoming-webhooks</p>
</blockquote>
<h2 id="mailgun-api"><a class="header" href="#mailgun-api">MailGun api</a></h2>
<blockquote>
<p>https://app.mailgun.com/app/account/security/api_keys</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="payment-provider"><a class="header" href="#payment-provider">Payment Provider</a></h1>
<h2 id="paypal"><a class="header" href="#paypal">Paypal</a></h2>
<h3 id="new-member"><a class="header" href="#new-member">New Member</a></h3>
<p>When a member creates a subscription, Paypal sends us a message via a webhook.  There is no guaranty that this will be immediate.
The message might not include all the expected information.</p>
<p>Hopefully we receive their <code>subscription_id</code> and their email address.
If the information isn't correct, we can modify it in the UI.</p>
<h3 id="evaluating-membership"><a class="header" href="#evaluating-membership">Evaluating Membership</a></h3>
<p>Memberships are evaluated when the server starts up and every day at the same time.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rfid"><a class="header" href="#rfid">RFID</a></h1>
<h1 id="reader"><a class="header" href="#reader">Reader</a></h1>
<p>We are using the RC522 RFID reader/writer module.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>Frequency Range</td><td>13.56 MHz ISM Band</td></tr>
<tr><td>Host Interface</td><td>SPI / I2C / UART</td></tr>
<tr><td>Operating Supply Voltage</td><td>2.5 V to 3.3 V</td></tr>
<tr><td>Max. Operating Current</td><td>13-26mA</td></tr>
<tr><td>Min. Current(Power down)</td><td>10ÂµA</td></tr>
<tr><td>Logic Inputs</td><td>5V Tolerant</td></tr>
<tr><td>Read Range</td><td>5 cm</td></tr>
</tbody></table>
</div>
<p><a href="https://lastminuteengineers.com/how-rfid-works-rc522-arduino-tutorial/">more info</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="esprfid"><a class="header" href="#esprfid">esprfid</a></h1>
<p><a href="https://github.com/esprfid/esp-rfid">esprfid github</a></p>
<p><a href="https://www.tindie.com/products/nardev/esp-rfid-relay-blue-board/">buy</a></p>
<p>The &quot;esprfid&quot; blue board works well for our purposes for the most part.</p>
<p>Some issues:</p>
<ul>
<li>after several months of operation, we've experienced memory corruption (this could have to do with how frequently we update it).</li>
<li>we currently don't have a verification step between the rfid reader and the member server</li>
<li>in the event of a power outage, we seem to lose connection (or at least we don't receive mqtt messages from the rfid device).  This could be related to the rfid device coming online before the mqtt broker is available.  Usually power cycling the rfid device gets restored to a state that can send/receive mqtt messages.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mqtt-examples"><a class="header" href="#mqtt-examples">mqtt examples</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Mqtt Command</th><th>Topic</th><th>Host</th><th>Port</th><th>Message</th></tr></thead><tbody>
<tr><td>sub</td><td>frontdoor/sync</td><td>localhost</td><td>1883</td><td></td></tr>
<tr><td>sub</td><td>frontdoor/send</td><td>localhost</td><td>1883</td><td></td></tr>
<tr><td>sub</td><td>frontdoor</td><td>localhost</td><td>1883</td><td></td></tr>
<tr><td>pub</td><td>frontdoor</td><td>localhost</td><td>1883</td><td>{&quot;doorip&quot;: &quot;192.168.1.211&quot;, &quot;cmd&quot;: &quot;listusr&quot;}</td></tr>
<tr><td>pub</td><td>frontdoor/sync</td><td>localhost</td><td>1883</td><td>{&quot;type&quot;:&quot;heartbeat&quot;,&quot;time&quot;:1616731044,&quot;ip&quot;:&quot;192.168.1.211&quot;,&quot;door&quot;:&quot;esp-rfid&quot;}</td></tr>
<tr><td>pub</td><td>frontdoor/send</td><td>localhost</td><td>1883</td><td>{&quot;cmd&quot;:&quot;log&quot;,&quot;type&quot;:&quot;access&quot;,&quot;time&quot;:'$(date +%s)',&quot;isKnown&quot;:&quot;true&quot;,&quot;access&quot;:&quot;Always&quot;,&quot;username&quot;:&quot;Fake User&quot;,&quot;uid&quot;:&quot;not an rfid tag&quot;,&quot;door&quot;:&quot;frontdoor&quot;}</td></tr>
<tr><td>pub</td><td>frontdoor</td><td>localhost</td><td>1883</td><td>{&quot;doorip&quot;: &quot;192.168.1.211&quot;, &quot;cmd&quot;: &quot;deletusers&quot;}</td></tr>
<tr><td>pub</td><td>frontdoor</td><td>localhost</td><td>1883</td><td>{&quot;doorip&quot;: &quot;192.168.1.211&quot;, &quot;cmd&quot;: &quot;adduser&quot;, &quot;user&quot;: &quot;dustin&quot;, &quot;uid&quot;: &quot;4755ca35&quot;, &quot;acctype&quot;:1,&quot;validuntil&quot;:-86400}</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h1>
<h2 id="highlevel"><a class="header" href="#highlevel">HighLevel</a></h2>
<p>For Dev purposes, we use a fake &quot;InMemory&quot; db.
We can seed fake content with generators (see <code>./test/generators</code>) that we have built.
The frontend gets embeded into the binary. So, we don't need docker to host any database.</p>
<ul>
<li>Install <a href="https://go.dev/doc/install">golang</a></li>
<li>Install <a href="https://nodejs.org/en/">Node</a></li>
<li>build and run with <code>make</code></li>
<li>Install dependencies (see: <a href="development/getting_started.html#install-dependencies">Install Dependencies</a>)</li>
</ul>
<p>e.g.</p>
<pre><code class="language-bash">make build-ui
make run
</code></pre>
<p>Hopefully that makes the app fairly easy to stand up and get to hacking on.</p>
<h2 id="install-dependencies"><a class="header" href="#install-dependencies">Install Dependencies</a></h2>
<p>Download go modules</p>
<blockquote>
<p>note: go modules might download automatically the first time you run the app</p>
</blockquote>
<pre><code class="language-bash">go get ./...
</code></pre>
<p>Download node_modules</p>
<pre><code class="language-bash">cd web
npm ci
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dev-setup"><a class="header" href="#dev-setup">Dev Setup</a></h1>
<blockquote>
<p>Note: The Docker and Remote-Containers setup will soon be deprecated for this project. Please refer to <a href="development/./getting_started.html">Getting Started</a> for more updated dev setup instructions.</p>
</blockquote>
<h2 id="the-easy-way-using-remote-containers"><a class="header" href="#the-easy-way-using-remote-containers">The Easy Way (using Remote-Containers)</a></h2>
<p>To get started quickly, follow these steps:</p>
<ol>
<li>Install <a href="https://www.docker.com/products/docker-desktop">Docker</a>, <a href="https://code.visualstudio.com/download">VS Code</a>, and the VS Code <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers">Remote-Containers</a> extension.</li>
<li>Clone the repo to a folder on WSL if you are using Windows for better performance.</li>
<li>Open the folder in VS Code and choose &quot;Reopen in Container&quot; or run the &quot;Remote-Containers: Open Folder in Container...&quot; command and select the local folder.</li>
</ol>
<p><img src="development//img/openFromContainer.gif" alt="Open from container" title="Open from container" /></p>
<p>You don't need to install any other dependencies.</p>
<p>To start the backend server, debug it in VS Code. Alternatively, you can use <code>sh buildandrun.sh</code> to start the server without debugging.</p>
<p>Please refer to the <a href="development//web/README.html">UI README</a> for instructions on starting the web app.</p>
<pre><code># navigate to ui folder
cd ui

# install node modules
$ npm ci

# run local env
$ npm run start
</code></pre>
<p>If you feel cramped in the VS Code terminal pane, you can still connect to dev container shell from your favorite terminal using</p>
<pre><code>docker exec -it -u vscode memberdashboard_dev_1 bash
</code></pre>
<p>Now, go write code and implement features!</p>
<hr />
<div style="break-before: page; page-break-before: always;"></div><h1 id="installing-flutter"><a class="header" href="#installing-flutter">Installing flutter</a></h1>
<p>Follow instructions for installing flutter manually: <a href="https://docs.flutter.dev/get-started/install/linux#install-flutter-manually">https://docs.flutter.dev/get-started/install/linux#install-flutter-manually</a></p>
<p>It's also recommended to install the <a href="https://docs.flutter.dev/get-started/editor">flutter dev tools</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="config-file"><a class="header" href="#config-file">CONFIG file</a></h1>
<p>This app requires a config file.
The path for the config file is set using the <code>MEMBER_SERVER_CONFIG_FILE</code> environment variable.</p>
<p>the <code>sample.config.json</code> can be used as a template for this file.</p>
<pre><code>export MEMBER_SERVER_CONFIG_FILE=&quot;/etc/hackrva/config.json&quot;
</code></pre>
<hr />
<div style="break-before: page; page-break-before: always;"></div><h1 id="development-tasks"><a class="header" href="#development-tasks">Development Tasks</a></h1>
<h2 id="database-migrations"><a class="header" href="#database-migrations">Database Migrations</a></h2>
<p>Database migrations are managed using <a href="https://github.com/golang-migrate/migrate">golang-migrate/migrate</a>. The CLI is already available when using Remote-Containers, otherwise it will need to be installed.</p>
<h2 id="how-to-add-a-migration"><a class="header" href="#how-to-add-a-migration">How to add a migration</a></h2>
<p>A migration can be added by creating an up and down migration file in the migrations folder. The migration file names should be named according to {sequentialNumber}<em>{description}.up.sql and {sequentialNumber}</em>{description}.down.sql. Migrations can be created with the following command.</p>
<pre><code>make migration name=&lt;NAME&gt;
</code></pre>
<p>Populate the up and down scripts. Up scripts should be idempotent. Down scripts should revert all changes made by up script</p>
<h2 id="how-to-run-a-migration"><a class="header" href="#how-to-run-a-migration">How to run a migration</a></h2>
<p>Migrations can be applied using the CLI</p>
<pre><code>make migrate-up
</code></pre>
<h2 id="generating-swagger-docs"><a class="header" href="#generating-swagger-docs">Generating Swagger Docs</a></h2>
<p>When using Remote-Containers, swagger documentation can be updated using.</p>
<pre><code>make swagger
</code></pre>
<p>Otherwise, follow instructions in <a href="development/./docs/README.html">./docs/README.md</a> to install swagger first.</p>
<h2 id="querying-postgres"><a class="header" href="#querying-postgres">Querying Postgres</a></h2>
<p>The following options are available if using Remote-Containers.</p>
<ul>
<li>Use the <a href="https://marketplace.visualstudio.com/items?itemName=ckolkman.vscode-postgres">PostgreSQL extension</a> in VS Code</li>
<li>Use pgAdmin on <a href="http://localhost:8080">localhost:8080</a> with info@hackrva.org/test</li>
<li>Use make run-sql or make run-sql-command</li>
</ul>
<h2 id="troubleshooting-devcontainer"><a class="header" href="#troubleshooting-devcontainer">Troubleshooting devContainer</a></h2>
<p>Sometimes i'm getting an error when tryign to build the containers.</p>
<pre><code>Command failed: docker inspect --type image memberdashboard_dev
</code></pre>
<p>This happened after I ran a <code>docker system prune -a</code>, but I think I've seen it before.</p>
<p>To fix this, build the containers with the following command then reopen vscode in Container</p>
<pre><code>docker-compose -f docker-compose.yml -f .devcontainer/docker-compose.yml build
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-install-golang-migrate"><a class="header" href="#how-to-install-golang-migrate">How to install golang-migrate</a></h1>
<pre><code>go install github.com/golang-migrate/migrate/v4/cmd/migrate
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="seed-the-db-with-test-data"><a class="header" href="#seed-the-db-with-test-data">Seed the DB with test data</a></h1>
<blockquote>
<p>note: before seeding the db, it has to be up and running with the current schema
run the db migrations</p>
</blockquote>
<pre><code>make migrate-up
</code></pre>
<p>seed the db</p>
<pre><code>make seed
</code></pre>
<p>This will create some random members and a test user.</p>
<div class="table-wrapper"><table><thead><tr><th>username</th><th>password</th></tr></thead><tbody>
<tr><td>test@test.com</td><td>test</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="mermaid.min.js"></script>
        <script type="text/javascript" src="mermaid-init.js"></script>
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
